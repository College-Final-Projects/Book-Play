<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Booking Details - Book&Play</title>
  <link rel="stylesheet" href="BookingDetails.css" />
</head>
<body>

  <!-- Venue Information Section -->
  <section class="venue-section" >
    <div class="venue-banner">
      <button class="back-btn" onclick="goBack()">‚Üê Back</button>
      <img src="" alt="Venue Image" class="venue-image" id="venueImage" />
      <div class="venue-overlay">
        <h1 class="venue-name" id="venueName"></h1>
        <p class="venue-location" id="venueLocation"></p>
      </div>
    </div>

    <div class="booking-info">
      <div class="info-grid">
        <div class="info-card">
          <span class="info-label">Booking Date</span>
          <span class="info-value" id="bookingDate">Loading...</span>
        </div>
        <div class="info-card">
          <span class="info-label">Time</span>
          <span class="info-value" id="bookingTime">Loading...</span>
        </div>
        <div class="info-card">
          <span class="info-label">Booking ID</span>
          <span class="info-value" id="bookingId"></span>
        </div>
        <div class="info-card total-price">
          <span class="info-label">Total Venue Price</span>
          <span class="info-value"><span id="totalPrice"></span></span>
        </div>
        <div class="info-card privacy-card">
          <span class="info-label">Privacy</span>
          <button class="privacy-toggle" id="privacyToggle">
            <span class="privacy-status">Public</span>
            <span class="privacy-icon">üåê</span>
          </button>
        </div>
      </div>

      <!-- Private Room Password -->
      <div class="password-section" id="passwordSection" style="display: none;">
        <div class="password-card">
          <h3>üîí Private Room Password</h3>
          <div class="password-display">
            <input type="text" id="roomPasswordInput" class="password-input" readonly style="display: none;">
            <code id="roomPassword"></code>
            <button class="copy-btn" id="copyPassword">üìã Copy</button>
            <button class="edit-password-btn" id="editPasswordBtn" style="display: none;">‚úèÔ∏è Edit</button>
            <button class="save-password-btn" id="savePasswordBtn" style="display: none;">üíæ Save</button>
            <button class="cancel-password-btn" id="cancelPasswordBtn" style="display: none;">‚ùå Cancel</button>
          </div>
          <p class="password-note">Share this password with players to join the private room</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Player List Section -->
  <section class="players-section">
    <div class="section-header">
      <h2 class="section-title">Players</h2>
      <div class="host-controls" id="hostControls">
        <button class="edit-prices-btn" id="editPricesBtn">‚úè Edit Prices</button>
        <button class="save-prices-btn" id="savePricesBtn" style="display: none;">üíæ Save Changes</button>
        <button class="cancel-edit-btn" id="cancelEditBtn" style="display: none;">‚ùå Cancel</button>
      </div>
    </div>

    <div class="players-scroll-container">
      <button class="scroll-arrow scroll-left" id="scrollLeft"><span>‚Äπ</span></button>

      <!-- Player Cards will be injected here -->
      <div class="players-horizontal-scroll" id="playersScroll"></div>

      <button class="scroll-arrow scroll-right" id="scrollRight"><span>‚Ä∫</span></button>
    </div>
  </section>

  <!-- Payment Reminder Section -->
  <section class="payment-section">
    <div class="payment-reminder">
      <div class="timer-container">
        <div class="timer-icon">‚è∞</div>
        <div class="timer-content">
          <h3 class="timer-title">Payment Deadline</h3>
          <div class="countdown-timer" id="countdown">
            <div class="time-unit">
              <span class="time-value" id="hours"></span>
              <span class="time-label">Hours</span>
            </div>
            <div class="time-separator">:</div>
            <div class="time-unit">
              <span class="time-value" id="minutes"></span>
              <span class="time-label">Minutes</span>
            </div>
            <div class="time-separator">:</div>
            <div class="time-unit">
              <span class="time-value" id="seconds"></span>
              <span class="time-label">Seconds</span>
            </div>
          </div>
          <p class="timer-message">
            You must pay at least <strong>20% (‚Ç™<span id="minimumAmount"></span>)</strong> of the total booking price before the timer expires, otherwise the booking will be automatically canceled.
          </p>
        </div>
      </div>
    </div>
  </section>



  <!-- Action Buttons -->
  <section class="actions-section">
    <div class="action-buttons">
      <button class="cancel-btn">Cancel Booking</button>
      <button class="pay-btn">Pay Now</button>
    </div>
  </section>

  <!-- Player Details Modal -->
  <div class="modal-overlay" id="playerModal">
    <div class="modal-content">
      <button class="modal-close" id="modalClose">&times;</button>
      <div class="modal-header">
        <img src="" alt="Player" class="modal-player-image" id="modalPlayerImage">
        <div class="modal-player-info">
          <h2 class="modal-player-name" id="modalPlayerName"></h2>
          <p class="modal-player-role" id="modalPlayerRole"></p>
        </div>
      </div>
      <div class="modal-body">
        <div class="profile-section">
          <h3>Profile Information</h3>
          <div class="profile-details">
            <div class="detail-item">
              <span class="detail-label">Member Since:</span>
              <span class="detail-value" id="memberSince"></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Games Played:</span>
              <span class="detail-value" id="gamesPlayed"></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Rating:</span>
              <span class="detail-value" id="playerRating"></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Favorite Sport:</span>
              <span class="detail-value" id="favoriteSport"></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Location:</span>
              <span class="detail-value" id="playerLocation"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <div class="modal-overlay" id="paymentModal">
    <div class="modal-content payment-modal">
      <button class="modal-close" id="paymentModalClose">&times;</button>
      <div class="modal-header">
        <h2>üí≥ Payment Details</h2>
      </div>
      <div class="modal-body">
        <div class="payment-summary">
          <div class="payment-item">
            <span class="payment-label">Total Venue Price:</span>
            <span class="payment-value">‚Ç™<span id="modalTotalPrice">0</span></span>
          </div>
          <div class="payment-item">
            <span class="payment-label">Your Required Payment:</span>
            <span class="payment-value">‚Ç™<span id="modalRequiredPayment">0</span></span>
          </div>
          <div class="payment-item">
            <span class="payment-label">Amount Already Paid:</span>
            <span class="payment-value">‚Ç™<span id="modalAmountPaid">0</span></span>
          </div>
          <div class="payment-item total-amount">
            <span class="payment-label">Amount to Pay:</span>
            <span class="payment-value">‚Ç™<span id="modalAmountToPay">0</span></span>
          </div>
        </div>
        
        <div class="initial-payment-section" id="initialPaymentSection" style="display: none;">
          <div class="initial-payment-info">
            <h3>üè¶ Initial Deposit (20%)</h3>
            <p>No one has paid the initial 20% deposit yet. This deposit is required to secure the booking.</p>
            <div class="checkbox-container">
              <input type="checkbox" id="payInitialDeposit" class="payment-checkbox">
              <label for="payInitialDeposit">Pay the initial 20% deposit (‚Ç™<span id="modalInitialDeposit">0</span>)</label>
            </div>
          </div>
        </div>
        

      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="cancelPayment">Cancel</button>
        <button class="btn-primary" id="confirmPayment">Confirm Payment</button>
      </div>
    </div>
  </div>

  <script src="BookingDetails.js"></script>

  <!-- === Booking Demo UI (MVP) === -->
  <div id="booking-demo" style="padding:12px 0;">
    <div id="summary">
      <div>Status: <span id="st"></span> | Window: <span id="win"></span> | Countdown: <span id="cd"></span></div>
      <div>Total: <span id="t_total"></span> | Paid: <span id="t_paid"></span> | Remaining: <span id="t_rem"></span></div>
    </div>

    <div id="actions" style="margin:8px 0;">
      <button id="btnDeposit" hidden>Pay 20% Deposit</button>
      <button id="btnPayNow" hidden>Pay Now</button>
      <button id="btnLeave" hidden>Leave Group</button>
      <button id="btnSmart" hidden>Smart Split</button>
      <button id="btnManageSplit" hidden>Manage Split</button>
    </div>

    <table id="ptab" border="0" cellpadding="6">
      <thead><tr><th>User</th><th>Owed</th><th>Paid</th></tr></thead>
      <tbody></tbody>
    </table>

    <!-- Manual Split Management (Host Only) -->
    <div id="manual-split" style="margin-top:12px; padding:8px; border:1px solid #ddd; display:none;">
      <div style="font-weight:bold; margin-bottom:8px;">Manual Split Management</div>
      <div id="split-inputs"></div>
      <button id="btnApplySplit" style="margin-top:8px;">Apply Manual Split</button>
      <button id="btnCancelSplit" style="margin-top:8px; margin-left:8px;">Cancel</button>
    </div>

    <pre id="log" style="margin-top:10px; white-space:pre-wrap;"></pre>
  </div>
  <!-- === End Booking Demo UI (MVP) === -->

  <script>
    // === Booking Demo UI JavaScript ===
    
    // Helpers
    function log(obj) { 
      document.getElementById('log').textContent = JSON.stringify(obj, null, 2); 
    }
    
    function fmt(n) { 
      return (Math.round(Number(n)*100)/100).toFixed(2); 
    }
    
    function formatHHMMSS(s) { 
      s = Math.max(0, parseInt(s||0,10)); 
      const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60; 
      return [h,m,sec].map(v=>String(v).padStart(2,'0')).join(':'); 
    }
    
    let countdownTimer=null;
    function startCountdown(sec, el) { 
      if(countdownTimer){clearInterval(countdownTimer);} 
      el.textContent = formatHHMMSS(sec); 
      let left = parseInt(sec||0,10); 
      countdownTimer = setInterval(()=>{ 
        left = Math.max(0, left-1); 
        el.textContent = formatHHMMSS(left); 
        if(left<=0) clearInterval(countdownTimer); 
      }, 1000); 
    }

    // State vars
    let bookingId = null; // set from server responses
    const me = window.currentUsername || ''; // host/member logic may use this

    // Render function
    function render(state) {
      // state is the unified JSON from router: {ok,status,totals,window,seconds_left,participants,booking_id}
      
      // 1) fill summary and totals
      document.getElementById('st').textContent = state.status || '';
      document.getElementById('win').textContent = state.window || '';
      document.getElementById('t_total').textContent = fmt(state.totals?.total_price || 0);
      document.getElementById('t_paid').textContent = fmt(state.totals?.total_paid || 0);
      document.getElementById('t_rem').textContent = fmt(state.totals?.remaining || 0);
      
      // 2) render participants rows
      const tbody = document.querySelector('#ptab tbody');
      tbody.innerHTML = '';
      if (state.participants) {
        state.participants.forEach(p => {
          const row = tbody.insertRow();
          row.insertCell(0).textContent = p.user_id || '';
          row.insertCell(1).textContent = fmt(p.required_payment || 0);
          row.insertCell(2).textContent = fmt(p.paid_amount || 0);
        });
      }
      
      // 3) show/hide buttons based on status/window + role
      const isHost = me && state.participants && state.participants[0]?.user_id === me;
      const isActive = state.window !== 'none';
      
      // Hide all buttons first
      document.getElementById('btnDeposit').hidden = true;
      document.getElementById('btnPayNow').hidden = true;
      document.getElementById('btnLeave').hidden = true;
      document.getElementById('btnSmart').hidden = true;
      document.getElementById('btnManageSplit').hidden = true;
      
      // Show cancellation notice if canceled
      let noticeDiv = document.getElementById('cancellation-notice');
      if (!noticeDiv) {
        noticeDiv = document.createElement('div');
        noticeDiv.id = 'cancellation-notice';
        noticeDiv.style.cssText = 'color: red; font-weight: bold; margin: 8px 0; padding: 8px; background: #ffe6e6; border: 1px solid #ff9999;';
        document.getElementById('summary').appendChild(noticeDiv);
      }
      
      if (state.status === 'canceled') {
        noticeDiv.style.display = 'block';
        const reason = state.reason === 'deposit_missed' ? 'Deposit not paid' : 'Payment deadline missed';
        noticeDiv.textContent = `Booking canceled ‚Äî ${reason}`;
      } else if (state.status === 'paid_in_full') {
        noticeDiv.style.display = 'block';
        noticeDiv.style.cssText = 'color: green; font-weight: bold; margin: 8px 0; padding: 8px; background: #e6ffe6; border: 1px solid #99ff99;';
        noticeDiv.textContent = 'Paid in full';
      } else {
        noticeDiv.style.display = 'none';
      }
      
      // Show buttons based on status and role
      if (state.status === 'canceled') {
        // No buttons shown for canceled bookings
      } else if (state.status === 'paid_in_full') {
        // No mutation buttons for fully paid bookings
      } else if (state.status === 'pending_deposit' && isHost) {
        document.getElementById('btnDeposit').hidden = false;
      } else if (state.status === 'active_payment_window' && isActive) {
        document.getElementById('btnPayNow').hidden = false;
        document.getElementById('btnLeave').hidden = false;
        if (isHost) {
          document.getElementById('btnSmart').hidden = false;
          document.getElementById('btnManageSplit').hidden = false;
        }
      }
      
      // 4) start countdown
      startCountdown(state.seconds_left, document.getElementById('cd'));
    }

    // Fetch helpers (GET for demo)
    async function api(action, params={}) {
      const usp = new URLSearchParams({ajax:'1', action, ...params});
      const res = await fetch('BookingDetails.php?'+usp.toString(), { credentials:'same-origin' });
      return res.json();
    }

    // Button wiring
    document.getElementById('btnDeposit').onclick = async () => {
      const r = await api('pay_deposit', { booking_id: bookingId, host_id: me||'host_demo' });
      log(r); render(r);
    };
    
    document.getElementById('btnPayNow').onclick = async () => {
      const amount = prompt('Enter amount to pay:','50');
      if(!amount) return;
      const r = await api('pay_share', { booking_id: bookingId, user_id: me||'u201', amount: amount });
      log(r); render(r);
    };
    
    document.getElementById('btnLeave').onclick = async () => {
      const r = await api('leave_group', { booking_id: bookingId, user_id: me||'u201' });
      log(r); render(r);
    };
    
    document.getElementById('btnSmart').onclick = async () => {
      const r = await api('smart_split', { booking_id: bookingId });
      log(r); render(r);
    };
    
    document.getElementById('btnManageSplit').onclick = () => {
      showManualSplit();
    };
    
    document.getElementById('btnApplySplit').onclick = async () => {
      const edits = collectSplitEdits();
      if (edits.length === 0) {
        alert('No changes to apply');
        return;
      }
      const r = await api('manage_split', { booking_id: bookingId, edits: JSON.stringify(edits) });
      log(r); 
      hideManualSplit();
      render(r);
    };
    
    document.getElementById('btnCancelSplit').onclick = () => {
      hideManualSplit();
    };

    // Manual split helper functions
    function showManualSplit() {
      const manualSplitDiv = document.getElementById('manual-split');
      const splitInputsDiv = document.getElementById('split-inputs');
      
      // Get current participants from the table
      const tbody = document.querySelector('#ptab tbody');
      const rows = tbody.querySelectorAll('tr');
      
      let inputsHtml = '';
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 3) {
          const userId = cells[0].textContent.trim();
          const currentOwed = cells[1].textContent.replace('$', '').trim();
          const paid = cells[2].textContent.replace('$', '').trim();
          
          // Only show inputs for active participants (not left users)
          if (!userId.includes('(left)')) {
            inputsHtml += `
              <div style="margin:4px 0;">
                <label>${userId}: $</label>
                <input type="number" step="0.01" min="${paid}" 
                       value="${currentOwed}" 
                       data-user="${userId}" 
                       style="width:80px; margin-left:4px;">
                <span style="font-size:12px; color:#666;">(paid: $${paid})</span>
              </div>
            `;
          }
        }
      });
      
      splitInputsDiv.innerHTML = inputsHtml;
      manualSplitDiv.style.display = 'block';
    }
    
    function hideManualSplit() {
      document.getElementById('manual-split').style.display = 'none';
    }
    
    function collectSplitEdits() {
      const inputs = document.querySelectorAll('#split-inputs input[data-user]');
      const edits = [];
      
      inputs.forEach(input => {
        const userId = input.getAttribute('data-user');
        const newOwed = parseFloat(input.value) || 0;
        const paid = parseFloat(input.getAttribute('min')) || 0;
        
        // Only include if owed amount is different from paid amount
        if (newOwed >= paid) {
          edits.push({
            user_id: userId,
            owed: newOwed.toFixed(2)
          });
        }
      });
      
      return edits;
    }

    // Boot logic
    (async () => {
      try {
        // 1) Try to get existing state
        let s = await api('get_booking', bookingId ? {booking_id: bookingId} : {});
        
        // If no booking exists, create a demo one
        if (!s.ok && (s.code === 'MISSING_BOOKING_ID' || s.code === 'USER_NOT_FOUND')) {
          const c = await api('create_booking', {
            host_id: me || 'host_demo',
            event_start_iso: '', // allow server default (now+2d 18:00)
            total_amount: 500,
            participants: JSON.stringify([me || 'host_demo','u201','u202','u203'])
          });
          s = c;
        }
        
        // 2) Set booking ID
        bookingId = s.booking_id || bookingId;
        
        // 3) Render state
        render(s);
        
      } catch (error) {
        log({error: error.message});
      }
    })();
  </script>
</body>
</html>
